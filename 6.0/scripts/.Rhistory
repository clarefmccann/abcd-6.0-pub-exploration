pub_f_y <- read_keep(
file.path(pub_data_root, "youth_tannerstages_f.csv"),
1L,
c(pete_y = "petef", peta_y = "petaf", petb_y = "petbf", petc_y = "petcf", petd_y = "petdf", PDSS_y = "PDSS"),
keep_youth
)
pub_m_y <- read_keep(
file.path(pub_data_root, "youth_tannerstages_m.csv"),
0L,
c(pete_y = "mpete", peta_y = "petam", petb_y = "petbm", petc_y = "petcm", petd_y = "petdm", PDSS_y = "PDSS"),
keep_youth
)
merged_p <- bind_rows(pub_f_p, pub_m_p) %>%
mutate(wave = recode(wave, !!!map_wave, .default = wave))
merged_y <- bind_rows(pub_f_y, pub_m_y) %>%
mutate(wave = recode(wave, !!!map_wave, .default = wave))
merged <- full_join(merged_p, merged_y, by = c("id","wave"), suffix = c(".p",".y")) %>%
mutate(
age = coalesce(age.p, age.y),
sex = coalesce(sex.p, sex.y)
) %>%
select(id, wave, age, sex, starts_with("pet"), starts_with("PDSS")) %>%
arrange(id, wave)
# also a wide version for MTMM / longitudinal
merged_wide <- merged %>%
pivot_wider(
id_cols   = c(id, sex),
names_from = wave,
values_from = c(age, starts_with("pet"), starts_with("PDSS"))
)
# ── 2) Helper utilities --------------------------------------------------------
p_items <- c("peta_p","petb_p","petc_p","petd_p")
y_items <- c("peta_y","petb_y","petc_y","petd_y")
make_thresh <- function(vars) {
as.vector(t(outer(vars, paste0("t", 1:3), \(i,t) paste0(i, "|", t))))
}
run_invariance <- function(data, items, model_syntax, group_var = "wave") {
fit_config <- cfa(
model_syntax,
data  = data,
estimator = "WLSMV",
parameterization = "delta",
ordered = items,
group = group_var,
std.lv = TRUE
)
fit_thresh <- update(fit_config, group.equal = "thresholds")
fit_metric <- update(fit_config, group.equal = c("thresholds","loadings"))
list(config = fit_config, thresh = fit_thresh, metric = fit_metric)
}
partial_from_items <- function(fit_config, free_items) {
update(
fit_config,
group.equal   = c("thresholds","loadings"),
group.partial = make_thresh(free_items)
)
}
# Re-level ordered items inside a subset to avoid empty categories for WLSMV
relevel_ordered <- function(df, vars) {
for (v in vars) {
x <- df[[v]]; if (is.null(x) || all(is.na(x))) next
df[[v]] <- factor(x, levels = sort(unique(stats::na.omit(x))), ordered = TRUE)
}
df
}
ordered_names_all <- function(prefixes = c("peta","petb","petc","petd"),
reporters = c("p","y"),
waves = c("bl", paste0("fu", 1:6))) {
c(outer(paste0(prefixes, "_", reporters[1], "_"), waves, paste0)) |>
c(outer(paste0(prefixes, "_", reporters[2], "_"), waves, paste0)) |>
as.vector()
}
# ── 3) Measurement invariance by sex and reporter ------------------------------
model_parent <- 'puberty =~ peta_p + petb_p + petc_p + petd_p'
model_youth  <- 'puberty =~ peta_y + petb_y + petc_y + petd_y'
### FEMALES (sex == 1)
dat_f_long <- subset(merged, sex == 1)
fits_p_f <- run_invariance(dat_f_long, p_items, model_parent)
knitr::opts_chunk$set(
echo = TRUE,
message = TRUE,
warning = TRUE
)
options(scipen=999)
library(pacman)
pacman::p_load(dplyr, ggplot2, tidyr, stringr, lubridate, psych, nlme, MuMIn, purrr, readr, install = TRUE)
proj_root = "/Users/clarefmccann/University\ of\ Oregon\ Dropbox/Clare\ McCann/mine/projects/abcd-projs/puberty/"
data_root = "/Users/clarefmccann/University\ of\ Oregon\ Dropbox/Clare\ McCann/mine/projects/abcd-projs/abcd-data-release-6.0/"
## SEX --> 1 = MALE, 2 = FEMALE (PARENT PDS)
#source(paste0(proj_root, "6.0/scripts/abcd_raw_pub_cleaning.R"))
#source(paste0(proj_root, "6.0/scripts/pds_to_ts.R"))
# ------------------------------------------------------------
# config
# ------------------------------------------------------------
# where to drop the csvs
out_dir <- "/Users/clarefmccann/University of Oregon Dropbox/Clare McCann/mine/projects/abcd-projs/puberty/pub_exp_output/regressors/6.0/"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
# canonical wave order
wave_levels <- c(
"ses-00A",
"ses-01A",
"ses-02A",
"ses-03A",
"ses-04A",
"ses-05A",
"ses-06A"
)
wave_labels <- c(
"ses-00A" = "BL",
"ses-01A" = "FU1",
"ses-02A" = "FU2",
"ses-03A" = "FU3",
"ses-04A" = "FU4",
"ses-05A" = "FU5",
"ses-06A" = "FU6")
allowed_transitions <- c(
"ses-00A to ses-01A",
"ses-00A to ses-02A",
"ses-00A to ses-03A",
"ses-00A to ses-04A",
"ses-00A to ses-05A",
"ses-00A to ses-06A",
"ses-01A to ses-02A",
"ses-01A to ses-03A",
"ses-01A to ses-04A",
"ses-01A to ses-05A",
"ses-01A to ses-06A",
"ses-02A to ses-03A",
"ses-02A to ses-04A",
"ses-02A to ses-05A",
"ses-02A to ses-06A",
"ses-03A to ses-04A",
"ses-03A to ses-05A",
"ses-03A to ses-06A",
"ses-04A to ses-05A",
"ses-04A to ses-06A",
"ses-05A to ses-06A")
# ------------------------------------------------------------
# core function
# ------------------------------------------------------------
generate_regressor_info <- function(df, label, sex, out_dir) {
stopifnot(all(c("id", "wave") %in% names(df)))
measures <- if (sex == "m") {
c("PDSS", "petam", "petbm", "petcm", "petdm", "mpete")
} else {
c("PDSS", "petaf", "petbf", "petcf", "petdf", "petef")
}
df_prepped <- df %>%
mutate(
wave = factor(wave, levels = wave_levels, ordered = TRUE),
wave_short = recode(
as.character(wave),
!!!wave_labels,
.default = as.character(wave)
)
) %>%
arrange(id, wave) %>%
group_by(id) %>%
{
out <- .
for (m in measures) {
diff_col <- paste0(m, "_diff")
out[[diff_col]] <- out[[m]] - dplyr::lag(out[[m]])
}
out$prev_wave       <- dplyr::lag(out$wave)
out$prev_wave_short <- dplyr::lag(out$wave_short)
out$prev_wave_idx   <- dplyr::lag(as.integer(out$wave))
out
} %>%
ungroup() %>%
mutate(
wave_change_clean = paste(
as.character(prev_wave), "to", as.character(wave)
)
) %>%
filter(
!is.na(prev_wave),
prev_wave_idx < as.integer(wave),
wave_change_clean %in% allowed_transitions
) %>%
mutate(
wave_change_clean = factor(
wave_change_clean,
levels = allowed_transitions,
ordered = TRUE
)
)
df_flags <- df_prepped %>%
filter(!is.na(wave_change_clean)) %>%
{
out <- .
for (m in measures) {
flag_col <- paste0(m, "_regressed")
diff_col <- paste0(m, "_diff")
out[[flag_col]] <- out[[diff_col]] < 0
}
out
}
trans_long <- df_flags %>%
select(id, wave_change_clean, ends_with("_regressed")) %>%
pivot_longer(
cols = ends_with("_regressed"),
names_to = "measure",
values_to = "regressed"
) %>%
mutate(measure = str_remove(measure, "_regressed"))
by_transition <- trans_long %>%
group_by(measure, wave_change_clean) %>%
summarise(
n_regressions = sum(regressed, na.rm = TRUE),
n_participants_regressed = n_distinct(id[regressed]),
.groups = "drop"
) %>%
arrange(measure, wave_change_clean)
ever_by_measure <- trans_long %>%
group_by(measure, id) %>%
summarise(any_regression = any(regressed, na.rm = TRUE), .groups = "drop") %>%
group_by(measure) %>%
summarise(n_participants_any_regression = sum(any_regression), .groups = "drop") %>%
arrange(measure)
id_pdss_counts <- df_flags %>%
group_by(id) %>%
summarise(
n_pdss_regressions = sum(PDSS_regressed, na.rm = TRUE),
any_pdss_regression = any(PDSS_regressed, na.rm = TRUE),
.groups = "drop"
)
per_transition_any <- df_flags %>%
group_by(id, wave_change_clean) %>%
summarise(any_pdss_reg = any(PDSS_regressed, na.rm = TRUE), .groups = "drop_last") %>%
group_by(id) %>%
summarise(n_transitions_pdss_reg = sum(any_pdss_reg), .groups = "drop")
regression_env <- id_pdss_counts %>%
left_join(per_transition_any, by = "id") %>%
mutate(n_transitions_pdss_reg = tidyr::replace_na(n_transitions_pdss_reg, 0L))
stopifnot(all(regression_env$n_transitions_pdss_reg <= length(wave_levels) - 1))
assign(paste0("filtered_regression_env_pdss_", label), regression_env, envir = .GlobalEnv)
assign(paste0("ids_to_drop_pdss_", label),
regression_env %>% dplyr::filter(any_pdss_regression) %>% dplyr::pull(id),
envir = .GlobalEnv)
write_csv(regression_env, file.path(out_dir, paste0("filtered_regression_env_", label, ".csv")))
write_csv(by_transition, file.path(out_dir, paste0("filtered_by_transition_", label, ".csv")))
write_csv(ever_by_measure, file.path(out_dir, paste0("filtered_ever_by_measure_", label, ".csv")))
invisible(list(by_transition = by_transition, ever_by_measure = ever_by_measure))
}
# ------------------------------------------------------------
# read data
# ------------------------------------------------------------
datasets <- list(
pds_m_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_m.csv")), sex = "m"),
pds_f_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_f.csv")), sex = "f"),
pds_m_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_m.csv")), sex = "m"),
pds_f_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_f.csv")), sex = "f")
)
regressor_results <- purrr::imap(
datasets,
~ {
suffix <- sub("^pds_", "", .y)
generate_regressor_info(df = .x$df, label = .y, sex = .x$sex, out_dir = out_dir)
}
)
combined_f <- inner_join(PDS_f_p_filtered, PDS_f_y_filtered, by = c("id", "wave")) %>%
rename(
PDSS_parent = PDSS.x,
PDSS_youth = PDSS.y
)
out_dir <- "/Users/clarefmccann/University of Oregon Dropbox/Clare McCann/mine/projects/abcd-projs/puberty/pub_exp_output/visualizations/6.0/"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
wave_levels <- c("ses-00A","ses-01A","ses-02A","ses-03A","ses-04A","ses-05A","ses-06A")
wave_labels <- c("ses-00A"="BL","ses-01A"="FU1","ses-02A"="FU2","ses-03A"="FU3","ses-04A"="FU4","ses-05A"="FU5","ses-06A"="FU6")
# keep the plot theme boring to avoid font shenanigans
theme_set(theme_minimal(base_size = 11))
# device safety net
safe_save <- function(plot, filename, width, height, dpi = 300) {
tryCatch(
ggsave(filename = filename, plot = plot, width = width, height = height, dpi = dpi, device = "png"),
error = function(e) {
message("ggsave failed for ", filename, " (", conditionMessage(e), "). retrying via png()...")
grDevices::png(filename = filename, width = width, height = height, units = "in", res = dpi)
print(plot)
grDevices::dev.off()
}
)
}
# ------------------------------------------------------------
# core function
# ------------------------------------------------------------
generate_visualizations <- function(df, label, sex, out_dir) {
stopifnot(all(c("id","wave","PDSS") %in% names(df)))
plot_color_sex <- if (sex == "f") "#92374D" else "#56667A"
informant <- dplyr::case_when(
stringr::str_detect(label, "_p$") ~ "parent",
stringr::str_detect(label, "_y$") ~ "youth",
TRUE ~ "unknown"
)
plot_color_reporter <- dplyr::case_when(
informant == "parent" ~ "#260F26",
informant == "youth"  ~ "#ECA72C", # orange
TRUE                  ~ "#260F26"    # a default fallback
)
dat <- df %>%
mutate(
wave = factor(wave, levels = wave_levels, ordered = TRUE),
wave_short = dplyr::recode(as.character(wave), !!!wave_labels, .default = as.character(wave))
) %>%
filter(is.finite(PDSS), is.finite(age), !is.na(wave))
# 1) means by wave with n labels
means_wave <- dat %>%
group_by(wave, wave_short) %>%
summarise(
mean_pdss = mean(PDSS),
sd_pdss   = sd(PDSS),
n         = dplyr::n(),
.groups = "drop"
)
p_means_wave <- ggplot(means_wave, aes(x = wave, y = mean_pdss, group = 1)) +
geom_line(color = plot_color_sex) +
geom_point(color = plot_color_sex) +
geom_text(aes(label = paste0("n=", n)), vjust = -0.8, size = 3) +
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Time Point",
y = "Mean Pubertal Stage",
title = paste0("Mean Pubertal Stage Across TP (", sex, ", ", informant, ")")
)
safe_save(p_means_wave, file.path(out_dir, paste0(label, "_means_by_wave_filtered.png")), 7, 4)
# 2) distribution by wave
p_box_wave <- ggplot(dat, aes(x = wave, y = PDSS)) +
geom_boxplot(fill = plot_color_sex, outlier.shape = NA, alpha = 0.6) + # use fill for boxes
geom_jitter(color = plot_color_sex, width = 0.15, alpha = 0.15, size = 0.7) +
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Time Point",
y = "Pubertal Stage",
title = paste0("Pubertal Stage Distribution by TP (", sex, ", ", informant, ")")
)
safe_save(p_box_wave, file.path(out_dir, paste0(label, "_box_by_wave_filtered.png")), 7.5, 4.5)
# 3) connected trajectories across age + GAM
p_spaghetti <- ggplot(dat, aes(x = age, y = PDSS, group = id)) +
#geom_line(alpha = 0.22, linewidth = 0.4, color = plot_color_sex) + # color for lines
#geom_point(alpha = 0.18, size = 0.8, color = plot_color_sex) +    # color for points
geom_smooth(aes(group = 1), # override the grouping for this layer only
method = "gam",
formula = y ~ s(x, k = 10),
se = TRUE,
color = plot_color_reporter,
fill = plot_color_reporter,
alpha = 0.2
) + #
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Age (years)",
y = "Pubertal Stage",
title = paste0("Pubertal Stage Across Age with Individual Trajectories (", sex, ", ", informant, ")")
)
safe_save(p_spaghetti, file.path(out_dir, paste0(label, "_age_spaghetti_gam_filtered_onlyline.png")), 7.5, 4.5)
# 4) observation counts per participant
obs_distribution <- dat %>%
count(id, name = "observations") %>%
count(observations, name = "participants_count") %>%
arrange(observations)
p_obs <- ggplot(obs_distribution, aes(x = factor(observations), y = participants_count)) +
geom_col(fill = plot_color_sex) +
labs(
x = "Observations Per Participant",
y = "Participants",
title = paste0("Observation Counts (", sex, ", ", informant, ")")
)
safe_save(p_obs, file.path(out_dir, paste0(label, "_obs_per_participant_filtered.png")), 6.5, 4)
write_csv(means_wave, file.path(out_dir, paste0("filtered_summary_means_by_wave_", label, ".csv")))
write_csv(obs_distribution, file.path(out_dir, paste0("filtered_summary_obs_per_participant_", label, ".csv")))
invisible(list(means_wave = means_wave, obs_distribution = obs_distribution))
}
# ------------------------------------------------------------
# read data and run (unchanged shape)
# ------------------------------------------------------------
datasets <- list(
pds_m_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_m.csv")), sex = "m"),
pds_f_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_f.csv")), sex = "f"),
pds_m_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_m.csv")), sex = "m"),
pds_f_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_f.csv")), sex = "f")
)
visualization_results <- purrr::imap(
datasets,
~ {
suffix <- sub("^pds_", "", .y)
generate_visualizations(df = .x$df, label = .y, sex = .x$sex, out_dir = out_dir)
}
)
out_dir <- "/Users/clarefmccann/University of Oregon Dropbox/Clare McCann/mine/projects/abcd-projs/puberty/pub_exp_output/visualizations/6.0/"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
wave_levels <- c("ses-00A","ses-01A","ses-02A","ses-03A","ses-04A","ses-05A","ses-06A")
wave_labels <- c("ses-00A"="BL","ses-01A"="FU1","ses-02A"="FU2","ses-03A"="FU3","ses-04A"="FU4","ses-05A"="FU5","ses-06A"="FU6")
# keep the plot theme boring to avoid font shenanigans
theme_set(theme_minimal(base_size = 11))
# device safety net
safe_save <- function(plot, filename, width, height, dpi = 300) {
tryCatch(
ggsave(filename = filename, plot = plot, width = width, height = height, dpi = dpi, device = "png"),
error = function(e) {
message("ggsave failed for ", filename, " (", conditionMessage(e), "). retrying via png()...")
grDevices::png(filename = filename, width = width, height = height, units = "in", res = dpi)
print(plot)
grDevices::dev.off()
}
)
}
# ------------------------------------------------------------
# core function
# ------------------------------------------------------------
generate_visualizations <- function(df, label, sex, out_dir) {
stopifnot(all(c("id","wave","PDSS") %in% names(df)))
plot_color_sex <- if (sex == "f") "#92374D" else "#56667A"
informant <- dplyr::case_when(
stringr::str_detect(label, "_p$") ~ "parent",
stringr::str_detect(label, "_y$") ~ "youth",
TRUE ~ "unknown"
)
plot_color_reporter <- dplyr::case_when(
informant == "parent" ~ "#260F26",
informant == "youth"  ~ "#ECA72C", # orange
TRUE                  ~ "#260F26"    # a default fallback
)
dat <- df %>%
mutate(
wave = factor(wave, levels = wave_levels, ordered = TRUE),
wave_short = dplyr::recode(as.character(wave), !!!wave_labels, .default = as.character(wave))
) %>%
filter(is.finite(PDSS), is.finite(age), !is.na(wave))
# 1) means by wave with n labels
means_wave <- dat %>%
group_by(wave, wave_short) %>%
summarise(
mean_pdss = mean(PDSS),
sd_pdss   = sd(PDSS),
n         = dplyr::n(),
.groups = "drop"
)
p_means_wave <- ggplot(means_wave, aes(x = wave, y = mean_pdss, group = 1)) +
geom_line(color = plot_color_sex) +
geom_point(color = plot_color_sex) +
geom_text(aes(label = paste0("n=", n)), vjust = -0.8, size = 3) +
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Time Point",
y = "Mean Pubertal Stage",
title = paste0("Mean Pubertal Stage Across TP (", sex, ", ", informant, ")")
)
safe_save(p_means_wave, file.path(out_dir, paste0(label, "_means_by_wave_filtered.png")), 7, 4)
# 2) distribution by wave
p_box_wave <- ggplot(dat, aes(x = wave, y = PDSS)) +
geom_boxplot(fill = plot_color_sex, outlier.shape = NA, alpha = 0.6) + # use fill for boxes
geom_jitter(color = plot_color_sex, width = 0.15, alpha = 0.15, size = 0.7) +
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Time Point",
y = "Pubertal Stage",
title = paste0("Pubertal Stage Distribution by TP (", sex, ", ", informant, ")")
)
safe_save(p_box_wave, file.path(out_dir, paste0(label, "_box_by_wave_filtered.png")), 7.5, 4.5)
# 3) connected trajectories across age + GAM
p_spaghetti <- ggplot(dat, aes(x = age, y = PDSS, group = id)) +
geom_line(alpha = 0.22, linewidth = 0.4, color = plot_color_sex) + # color for lines
geom_point(alpha = 0.18, size = 0.8, color = plot_color_sex) +    # color for points
geom_smooth(aes(group = 1), # override the grouping for this layer only
method = "gam",
formula = y ~ s(x, k = 10),
se = TRUE,
color = plot_color_reporter,
fill = plot_color_reporter,
alpha = 0.2
) + #
coord_cartesian(ylim = c(1, 5)) +
labs(
x = "Age (years)",
y = "Pubertal Stage",
title = paste0("Pubertal Stage Across Age with Individual Trajectories (", sex, ", ", informant, ")")
)
safe_save(p_spaghetti, file.path(out_dir, paste0(label, "_age_spaghetti_gam_filtered.png")), 7.5, 4.5)
# 4) observation counts per participant
obs_distribution <- dat %>%
count(id, name = "observations") %>%
count(observations, name = "participants_count") %>%
arrange(observations)
p_obs <- ggplot(obs_distribution, aes(x = factor(observations), y = participants_count)) +
geom_col(fill = plot_color_sex) +
labs(
x = "Observations Per Participant",
y = "Participants",
title = paste0("Observation Counts (", sex, ", ", informant, ")")
)
safe_save(p_obs, file.path(out_dir, paste0(label, "_obs_per_participant_filtered.png")), 6.5, 4)
write_csv(means_wave, file.path(out_dir, paste0("filtered_summary_means_by_wave_", label, ".csv")))
write_csv(obs_distribution, file.path(out_dir, paste0("filtered_summary_obs_per_participant_", label, ".csv")))
invisible(list(means_wave = means_wave, obs_distribution = obs_distribution))
}
# ------------------------------------------------------------
# read data and run (unchanged shape)
# ------------------------------------------------------------
datasets <- list(
pds_m_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_m.csv")), sex = "m"),
pds_f_p = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_parent_tannerstages_f.csv")), sex = "f"),
pds_m_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_m.csv")), sex = "m"),
pds_f_y = list(df = read.csv(paste0(data_root, "physical-health/puberty/filtered_youth_tannerstages_f.csv")), sex = "f")
)
visualization_results <- purrr::imap(
datasets,
~ {
suffix <- sub("^pds_", "", .y)
generate_visualizations(df = .x$df, label = .y, sex = .x$sex, out_dir = out_dir)
}
)
